# Alpine Linux Kernel Config for M-series (M1-M5)
# Optimized for Apple Silicon ARM64
# Minimum: ARMv8.4-A (M1)
# Maximum: ARMv9.2-A (M5)

# Architecture - M-series specific
CONFIG_ARM64=y
CONFIG_ARM64_PAGE_SHIFT=14  # 16K pages (better for M-series unified memory)
CONFIG_ARM64_VA_BITS=48
CONFIG_ARM64_PA_BITS=48

# CPU Features - All M-series have these
CONFIG_ARM64_LSE_ATOMICS=y  # Large System Extensions
CONFIG_ARM64_CRYPTO=y       # Hardware crypto acceleration
CONFIG_CRYPTO_SHA256_ARM64=y
CONFIG_CRYPTO_SHA512_ARM64=y
CONFIG_CRYPTO_AES_ARM64_CE=y  # Crypto Extensions (AES)
CONFIG_CRYPTO_CRC32_ARM64_CE=y  # Hardware CRC32 (ZFS loves this!)

# NEON/ASIMD - Vector operations
CONFIG_KERNEL_MODE_NEON=y
CONFIG_ARM64_NEON=y

# Performance governors - M-series handles this in hardware
CONFIG_CPU_FREQ=y
CONFIG_CPU_FREQ_DEFAULT_GOV_PERFORMANCE=y
CONFIG_CPUFREQ_DT=y

# Memory - Unified memory architecture
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y  # M-series has fast page table walks
CONFIG_COMPACTION=y
CONFIG_MIGRATION=y
CONFIG_KSM=y  # Kernel same-page merging (efficient with unified memory)

# Storage - NVMe only (no slow disk support needed)
CONFIG_BLK_DEV_NVME=y
CONFIG_NVME_CORE=y
CONFIG_NVME_MULTIPATH=y
CONFIG_NVME_TCP=y

# Disable slow storage we'll never use
# CONFIG_ATA is not set
# CONFIG_SCSI is not set (except for virtio)
CONFIG_SCSI_VIRTIO=y  # Only for VM
# CONFIG_USB_STORAGE is not set

# Filesystem - ZFS optimized
CONFIG_TMPFS=y
CONFIG_TMPFS_POSIX_ACL=y
CONFIG_TMPFS_XATTR=y
CONFIG_HUGETLBFS=y  # Large pages for ZFS ARC

# Ramdisk for ZFS temp operations
CONFIG_BLK_DEV_RAM=y
CONFIG_BLK_DEV_RAM_COUNT=16
CONFIG_BLK_DEV_RAM_SIZE=2097152  # 2GB ramdisk (we have unified memory!)

# Network - Virtio only in VM
CONFIG_VIRTIO_NET=y
CONFIG_NET_9P=y
CONFIG_NET_9P_VIRTIO=y
CONFIG_9P_FS=y
CONFIG_VIRTIO_FS=y  # virtiofs for fast host sharing

# Virtualization guest support
CONFIG_VIRTIO=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_BALLOON=y
CONFIG_VIRTIO_INPUT=y
CONFIG_VIRTIO_MMIO=y
CONFIG_HW_RANDOM_VIRTIO=y

# Security - M-series has secure enclave
CONFIG_ARM64_PTR_AUTH=y  # Pointer authentication
CONFIG_ARM64_BTI=y       # Branch Target Identification

# Cache optimization
CONFIG_CACHE_L2X0=y
CONFIG_SMP=y
CONFIG_NR_CPUS=16  # M5 has up to 16 cores (12P+4E)

# Scheduler - Asymmetric (performance + efficiency cores)
CONFIG_SCHED_MC=y
CONFIG_SCHED_SMT=y
CONFIG_SCHED_CLUSTER=y  # M-series has performance/efficiency clusters

# Disable debug for performance
# CONFIG_DEBUG_KERNEL is not set
# CONFIG_DEBUG_INFO is not set
# CONFIG_FTRACE is not set

# Timer - High resolution
CONFIG_HIGH_RES_TIMERS=y
CONFIG_NO_HZ_FULL=y

# DMA - M-series specific
CONFIG_ARM64_DMA_USE_IOMMU=y
CONFIG_IOMMU_SUPPORT=y

# Power management - Let M-series hardware handle it
CONFIG_PM=y
CONFIG_PM_SLEEP=y
CONFIG_SUSPEND=y
CONFIG_PM_AUTOSLEEP=y
CONFIG_CPU_IDLE=y

# Disable unnecessary drivers
# CONFIG_WIRELESS is not set (VM doesn't need it)
# CONFIG_WLAN is not set
# CONFIG_SOUND is not set
# CONFIG_FB is not set (headless)
# CONFIG_DRM is not set (headless)
# CONFIG_MEDIA_SUPPORT is not set

# Compression - Hardware accelerated where possible
CONFIG_CRYPTO_LZ4=y
CONFIG_CRYPTO_ZSTD=y
CONFIG_ZRAM=y  # Compressed RAM (fast with M-series)
CONFIG_ZRAM_DEF_COMP_ZSTD=y

# Minimal module support - built-in for speed
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
# CONFIG_MODULE_FORCE_UNLOAD is not set

# ZFS-specific optimizations
# (Applied via module parameters, not kernel config)
