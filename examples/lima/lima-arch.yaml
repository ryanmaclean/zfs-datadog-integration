# Lima VM Configuration for Arch Linux with OpenZFS
# ARM64 native support

vmType: "vz"
os: "Linux"
arch: "aarch64"

images:
  - location: "https://geo.mirror.pkgbuild.com/images/latest/Arch-Linux-aarch64-cloudimg.qcow2"
    arch: "aarch64"

cpus: 2
memory: "4GiB"
disk: "20GiB"

mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true

containerd:
  system: false
  user: false

provision:
  - mode: system
    script: |
      #!/bin/sh
      set -eux
      
      # Update system
      pacman -Syu --noconfirm
      
      # Install ZFS from archzfs repo
      # Add archzfs repository
      cat >> /etc/pacman.conf <<'EOF'
[archzfs]
Server = https://archzfs.com/$repo/$arch
EOF
      # Import archzfs GPG key
      pacman-key -r DDF7DB817396A49B2A2723F7403BD972F75D9D76
      pacman-key --lsign-key DDF7DB817396A49B2A2723F7403BD972F75D9D76
      
      # Install OpenZFS
      pacman -Sy --noconfirm zfs-linux
      
      # Install utilities
      pacman -S --noconfirm curl openbsd-netcat python jq
      
      # Load ZFS module
      modprobe zfs || true
      
      echo "Arch Linux with OpenZFS ready"
      zfs version
probes:
  - description: "ZFS module loaded"
    script: |
      #!/bin/sh
      lsmod | grep -q zfs
    hint: "ZFS kernel module should be loaded"

message: |
  Arch Linux VM with OpenZFS ready!
  
  To access: limactl shell arch-zfs
  Check ZFS: zfs version
